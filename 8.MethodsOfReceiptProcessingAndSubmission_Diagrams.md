# Section 8: Methods of Receipt Processing and Submission to FIRS – Diagrams

This file defines the visuals for Section 8. The goal is to make the full transaction lifecycle explicit, from intake through validation and regulator clearance to archival and feedback.

---

## Diagram 21: End to End Processing Flow

### Intent
Show the complete journey of an invoice from any intake channel into Bluelight SmartAPI, through pre submission checks, secure submission to FIRS MBS, receipt handling, and archival with evidence. The diagram must reassure both IT and Finance that every stage is controlled and observable.

### Canvas Layout
Left to right banded swimlanes:
1) Intake Channels  
2) SmartAPI Compliance Engine  
3) FIRS MBS  
4) Feedback and Evidence

### Elements to Show

**Intake Channels lane**
- Four entry boxes with icons:
  - SmartAPI REST from ERP or billing system
  - File and SFTP batch drop
  - Email Connector inbox
  - BlueBox capture from print or folder
- Each entry arrow labeled with example formats:
  - JSON, XML, CSV, IDoc, PDF

**SmartAPI Compliance Engine lane**
- A large box with a vertical checklist of stages:
  1. Schema validation and normalization
  2. Reference checks against libraries (TIN, HS, tax codes)
  3. Business rule checks (header totals vs line totals, currency precision)
  4. Signing service (PKCS7) and QR preparation
  5. Idempotency key assignment and dedup guard
- Side panel for resilience features:
  - Retry with exponential backoff
  - Replay queue
  - Dead letter queue
- Monitoring strip above the box:
  - Throughput, latency, error rate gauges

**FIRS MBS lane**
- Regulator endpoint box with TLS 1.3 badge
- Two response paths shown:
  - Synchronous acknowledgement
  - Asynchronous clearance result
- Status types labeled:
  - Acknowledged, Cleared, Rejected, Pending

**Feedback and Evidence lane**
- Three outputs branching from SmartAPI after FIRS response:
  - Callback webhooks to ERP or polling endpoint
  - Email acknowledgement back to sender for Email Connector flows
  - Dashboard update tiles for Finance and IT
- Evidence bundle box with contents listed:
  - Canonical JSON payload
  - Signed payload
  - IRN and QR
  - Clearance receipt
  - Audit log extract
- WORM archive icon with 10 year retention tag

### Mandatory Flows
1) Any intake channel → SmartAPI validation → FIRS submission  
2) FIRS response → SmartAPI routes to callbacks and dashboards  
3) Evidence bundle written to WORM archive with correlation ID

### Callouts
- Early rejection at SmartAPI avoids regulator rejects where possible
- Idempotency guarantees no duplicates on retry
- Queue and replay ensure zero invoice loss during outages

### Style
- Use color bands to distinguish lanes
- Green ticks for passed checks, amber for pending, red for rejects
- Keep labels short on arrows, expand details in side callouts

---

## Diagram 22: Evidence Lifecycle and Archival

### Intent
Detail how every cleared transaction is converted into an audit ready evidence package, how it is stored, and how it is retrieved by Finance, Compliance, and Auditors. The diagram must communicate immutability and traceability.

### Canvas Layout
Top to bottom flow with three horizontal zones:
1) Post clearance enrichment  
2) Evidence packaging and storage  
3) Retrieval and audit

### Elements to Show

**Post clearance enrichment**
- Input box labeled Clearance Result with fields:
  - IRN, QR, FIRS timestamp, status
- Merge step showing association with:
  - Canonical payload
  - PKCS7 signature file
  - Correlation ID and submission timeline

**Evidence packaging and storage**
- Evidence pack builder box listing artifacts included:
  - Canonical JSON
  - Signed submission
  - FIRS receipt and IRN
  - QR image
  - Audit log extract with hash chain reference
  - Optional reconciliation report link
- Arrow to **Immutable WORM Archive** with:
  - AES 256 at rest badge
  - Retention policy 10 years
  - Versioning enabled
  - Region residency tag for Nigeria when required

**Retrieval and audit**
- Three consumer icons with read only badges:
  - Finance: month end reconciliation and reprints
  - Compliance: regulator response and evidence export
  - External Auditor: controlled portal or API access
- Search panel depiction with filters:
  - Invoice number, IRN, TIN, date range, company code
- Export options:
  - Single invoice bundle as ZIP
  - Periodic bulk export with digitally signed manifest

### Mandatory Flows
1) Clearance result + canonical + signature → evidence pack builder  
2) Evidence pack → WORM archive with immutable timestamp  
3) Role based retrieval via dashboard or API → export with signed manifest

### Callouts
- Tamper evidence: hash chained audit logs referenced in the bundle
- Legal hold: ability to mark records for extended retention
- Performance: typical retrieval in seconds with indexed search

### Style
- Use sealed box iconography for the WORM archive
- Show small padlock and certificate icons next to signature and manifest items
- Keep retrieval side clean and business friendly to appeal to Finance and Audit

---
