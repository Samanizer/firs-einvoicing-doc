# Section 5: Security Architecture â€“ Diagrams

This file specifies every visual required for Section 5. Each diagram includes intent, mandatory elements, flows, callouts, and style guidance to ensure consistent, audit grade communication.

---

## Diagram 13: End to End Security Layers

### Intent
Show a full stack view of security from client systems through Bluelight SmartAPI to FIRS MBS and the immutable archive. Highlight controls at transport, identity, application, data, monitoring, and governance layers. The viewer should immediately see how confidentiality, integrity, availability, and auditability are enforced.

### Canvas Layout
Left to right swimlanes:
1) Client Enterprise  
2) Network Perimeter  
3) Bluelight SmartAPI Compliance Core  
4) FIRS MBS  
5) Evidence Archive and Observability

### Elements to Show

**Client Enterprise lane**
- ERP or billing systems: SAP, Oracle, Dynamics, Legacy icons.
- Optional channels: Email client for Email Connector, printer and folder icons for BlueBox, browser icon for BlueInvoice.
- User roles panel with three groups: Finance, IT Operations, Compliance. Each role shows RBAC scope badges such as View Only, Submit, Admin.
- SSO block for dashboard access with MFA badge.

**Network Perimeter lane**
- Primary connection label: HTTPS TLS 1.3.
- Authentication options side labels: mTLS with client certificate, OAuth 2.0 with JWT.
- IP allowlisting badge and optional VPN tunnel badge between Client and SmartAPI.
- HSTS enabled label on public endpoints.
- DDoS and WAF shields in front of SmartAPI public ingress.

**Bluelight SmartAPI Compliance Core lane**
- Security sublayers stacked inside one large box:
  - Identity and Access
    - OAuth 2.0 Authorization Server, token scopes, short token lifetime note.
    - mTLS trust store, certificate pinning note.
    - RBAC engine with least privilege and role separation.
    - Admin console protected by SSO and MFA.
  - Application Controls
    - Schema validation, input sanitization, request size limits.
    - Rate limiting and quota enforcement.
    - Idempotency keys and replay protection.
    - Safe retries and circuit breaker on upstream regulator calls.
  - Cryptography and Secrets
    - PKI signing service backed by HSM, key rotation policy.
    - AES 256 encryption at rest on databases and object storage.
    - Secrets manager for API keys and certificates with rotation schedules.
  - Monitoring and Detection
    - Centralized audit log pipeline with hash chaining.
    - Metrics and traces exporters.
    - SIEM connector with rules for failed auth spikes, unusual geos, payload anomalies, queue backlogs.
    - Certificate expiry watchdog with T minus 30, T minus 7, T minus 1 day alerts.
  - Governance
    - Change management and CAB reference.
    - Vulnerability management and patch cadence.
    - Penetration testing gates for UAT and pre production.
    - Quarterly access reviews and segregation of duties checks.

**FIRS MBS lane**
- Regulator endpoint icon with HTTPS TLS 1.3 label.
- Note that regulator latency is measured separately from SmartAPI processing.

**Evidence Archive and Observability lane**
- WORM storage icon with Immutability seal and 10 year retention tag.
- Evidence bundle contents list: canonical payload, signed payload, IRN and receipt, QR image, audit log extract.
- Read only access paths for Finance, Compliance, and external auditors.
- Observability panel: dashboards for Finance and IT, alert routing to ServiceNow, Jira, Teams or email.

### Mandatory Flows
1) Client ERP to SmartAPI over TLS 1.3 with mTLS or OAuth 2.0 JWT.  
2) SmartAPI to FIRS MBS over TLS 1.3.  
3) SmartAPI writes evidence bundle to WORM with AES 256 at rest.  
4) Dashboards and APIs access data through RBAC and MFA.  
5) Logs, metrics, and traces stream to SIEM and monitoring with alert routes to client SOC and Bluelight Ops.

### Callouts
- Confidentiality: TLS 1.3 everywhere, AES 256 at rest.  
- Integrity and non repudiation: PKCS7 signatures, hash chained audit logs.  
- Availability: autoscaling, circuit breakers, retries, DR targets RPO 15 minutes and RTO 2 hours.  
- Residency: NG OPCO hosting option flagged where required.  
- Compliance: ISO 27001 alignment and OWASP API Security Top 10 coverage.

### Style
- Color coding: grey for client, blue for SmartAPI, green for regulator, navy for archive, orange for monitoring.  
- Use shield icons for controls, key icons for crypto, bell icons for alerts, ledger icons for audit.  
- Provide a compact legend explaining TLS, mTLS, OAuth 2.0, PKCS7, WORM.

---

## Diagram 14: Signature and QR Integrity Chain

### Intent
Explain how each invoice gains integrity and non repudiation from signing through verification, and how the QR payload relates to the signed content. The diagram must help both security teams and auditors understand verification steps.

### Canvas Layout
Top to bottom linear flow with two verification branches on the right. Finish with evidence archival at the bottom.

### Elements to Show

**Source Payload**
- Box labeled Canonical Invoice JSON.
- Mini list of critical fields: supplier TIN, buyer TIN, invoice number, issue date, totals, tax lines, HS codes, correlation ID.

**Hash and Sign**
- Arrow to hashing block labeled SHA 256 payload digest.
- Arrow to Signing Service box with PKI and HSM badges.
- Output artifact labeled PKCS7 detached or enveloped signature, note policy OID and certificate CN.

**Secure Transport and Clearance**
- Arrow to FIRS MBS endpoint with TLS 1.3 badge.
- Return arrow from FIRS labeled IRN, QR payload, clearance timestamp.

**QR Code Composition**
- Box showing QR contents or references, for example:
  - IRN  
  - Supplier TIN  
  - Invoice number  
  - Issue date and checksum  
  - Signature hash reference or short digest  
- Render a QR icon with caption Scan to verify at regulator.

**Verification Paths**
- Branch A External: mobile device scans QR, opens regulator verification page, status shows Cleared with IRN and timestamp.  
- Branch B Internal: verification service recomputes SHA 256 on canonical payload, validates PKCS7 using public certificate, cross checks IRN and invoice metadata, outputs Pass or Fail with reason.

**Audit and Evidence**
- Audit log entry created capturing:
  - Correlation ID  
  - Submitter identity  
  - Signature thumbprint  
  - Signed time and receipt time in UTC  
  - Verification outcome  
- Evidence bundle box listing contents:
  - Canonical JSON  
  - PKCS7 signature  
  - IRN and receipt JSON  
  - QR image  
  - Audit log extract  
- WORM and retention 10 years tags.

### Mandatory Flows
1) Canonical JSON to SHA 256 digest to PKCS7 signature.  
2) Signed payload to FIRS MBS, response includes IRN and QR payload.  
3) QR scan to regulator verification and internal crypto verification branch.  
4) Evidence bundle creation and storage in immutable archive.

### Callouts
- Non repudiation: signature binds payload to client identity via certificate.  
- Integrity: any change to payload invalidates digest and signature.  
- Time accuracy: signed time and regulator receipt time recorded for audit.  
- Idempotency: repeat submissions with the same idempotency key return prior state, prevents duplicates.

### Style
- Keep crypto steps visually distinct with lock and fingerprint icons.  
- Use green check for verification pass and red cross for fail.  
- Include a small legend defining SHA 256, PKCS7, IRN, QR, WORM for non specialists.

---

## Optional Inset: Threat Model Snapshot

### Intent
Provide a compact misuse case panel that security teams can reference.

### Items
- Threats: credential theft, expired certificates, payload tampering, DDoS, regulator outage.  
- Controls: MFA and RBAC, certificate watchdog and rotation, PKCS7 integrity, WAF and rate limits, queue and replay with backoff.  
- Residual risks and monitoring hooks: SIEM rules for geolocation anomalies, token misuse, and rejection spikes.

Style: small bordered box placed at the bottom right of Diagram 13 or as a separate inset.

